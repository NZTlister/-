<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D 手势粒子 (高速非阻塞版)</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #canvas-container { position: absolute; width: 100%; height: 100%; z-index: 1; }
        #video-input { position: absolute; bottom: 10px; right: 10px; width: 120px; z-index: 10; transform: scaleX(-1); display: none; border: 1px solid #fff; }
        
        #overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:100; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid #00d2ff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;}
        #status { color: #ccc; font-size: 14px; text-align: center; max-width: 80%; line-height: 1.5; }
        
        button { margin-top: 20px; padding: 10px 25px; border-radius: 20px; cursor: pointer; border: 1px solid #00d2ff; background: rgba(0,210,255,0.1); color: #00d2ff; }
        #start-btn { display: none; font-weight: bold; transform: scale(1.1); }
        #force-btn { display: none; margin-top: 15px; font-size: 12px; color: #aaa; border-color: #555; background: none; }
        
        #console-log { position: absolute; bottom: 0; left: 0; width: 100%; height: 120px; background: rgba(0,0,0,0.6); color: #0f0; font-size: 10px; overflow-y: scroll; z-index: 200; pointer-events: none; display: none; padding: 5px;}
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script src="https://unpkg.zhimg.com/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous" defer></script>
    <script src="https://unpkg.zhimg.com/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous" defer></script>
    <script src="https://unpkg.zhimg.com/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous" defer></script>
    <script src="https://unpkg.zhimg.com/@mediapipe/hands/hands.js" crossorigin="anonymous" defer></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://registry.npmmirror.com/three/0.160.0/files/build/three.module.js",
                "three/addons/": "https://registry.npmmirror.com/three/0.160.0/files/examples/jsm/",
                "lil-gui": "https://registry.npmmirror.com/lil-gui/0.19.1/files/dist/lil-gui.esm.min.js"
            }
        }
    </script>
</head>
<body>
    <div id="console-log"></div>
    <video id="video-input" playsinline></video>
    <div id="canvas-container"></div>
    
    <div id="overlay">
        <div class="spinner" id="spinner"></div>
        <div id="status">资源加载中...<br>(如果超过 8 秒无反应，将出现强制按钮)</div>
        <button id="start-btn">启动 (START)</button>
        <button id="force-btn">等待太久? 跳过检测强制运行</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import GUI from 'lil-gui';

        // 简易日志工具
        const logBox = document.getElementById('console-log');
        function log(msg) {
            logBox.style.display = 'block';
            logBox.innerHTML += `<div>> ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }
        window.onerror = (msg) => log(`ERR: ${msg}`);

        log("页面逻辑已启动 (HTML Parsing Done)");

        const els = {
            status: document.getElementById('status'),
            start: document.getElementById('start-btn'),
            force: document.getElementById('force-btn'),
            spinner: document.getElementById('spinner'),
            video: document.getElementById('video-input'),
            overlay: document.getElementById('overlay')
        };

        let scene, camera, renderer, particles, geometry, material;
        let positionsOriginal = [], handScaleFactor = 1.0, isRunning = false;
        let loaded = false;

        // --- 1. 资源检测循环 ---
        const checkTimer = setInterval(() => {
            // 检查 MediaPipe 全局变量是否就绪
            if (window.Hands && window.Camera) {
                clearInterval(checkTimer);
                loaded = true;
                onLoaded();
            }
        }, 500);

        function onLoaded() {
            log("MediaPipe & Three.js 就绪");
            els.spinner.style.display = 'none';
            els.status.innerText = "资源加载完毕 ✅";
            els.start.style.display = 'block';
            els.force.style.display = 'none';
        }

        // --- 2. 超时急救逻辑 ---
        setTimeout(() => {
            if (!loaded) {
                log("超时警告：CDN连接缓慢");
                els.status.innerText = "网络似乎有点慢...";
                els.force.style.display = 'block'; // 显示强制按钮
            }
        }, 8000);

        // 强制运行按钮（即使库没加载完，也尝试运行，或者让用户知道出错了）
        els.force.addEventListener('click', () => {
            if(window.Hands) {
                onLoaded();
            } else {
                alert("核心 AI 库尚未下载完成，强制运行可能会报错。\n请尝试切换 WiFi/4G 网络再刷新。");
                // 即使报错也尝试显示按钮，万一只是检测逻辑卡了呢
                els.force.style.display = 'none';
                els.start.style.display = 'block';
            }
        });

        // --- 3. 启动主逻辑 ---
        els.start.addEventListener('click', async () => {
            els.start.style.display = 'none';
            els.spinner.style.display = 'block';
            els.status.innerText = "正在请求摄像头...";

            try {
                const hands = new window.Hands({locateFile: (file) => {
                    return `https://unpkg.zhimg.com/@mediapipe/hands/${file}`;
                }});
                
                hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                hands.onResults(onHandResults);

                const cameraUtils = new window.Camera(els.video, {
                    onFrame: async () => { await hands.send({image: els.video}); },
                    width: 640, height: 480, facingMode: "user"
                });
                
                await cameraUtils.start();
                
                initThree();
                animate();

                els.video.style.display = 'block';
                els.overlay.style.opacity = 0;
                setTimeout(() => els.overlay.style.display = 'none', 500);
                isRunning = true;

            } catch (e) {
                log("启动错误: " + e.message);
                alert("启动失败: " + e.message);
                els.start.style.display = 'block';
            }
        });

        // --- 4. Three.js 场景 ---
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 20;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            new OrbitControls(camera, renderer.domElement).enableDamping = true;

            updateShape('Galaxy');
            
            // 纯代码纹理
            const c = document.createElement('canvas'); c.width=32; c.height=32;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle = g; ctx.fillRect(0,0,32,32);
            const tex = new THREE.Texture(c); tex.needsUpdate = true;

            material = new THREE.PointsMaterial({ color: '#00d2ff', size: 0.15, map: tex, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending, depthWrite: false });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            const gui = new GUI({ title: 'Control' });
            gui.domElement.style.marginTop = '20px';
            gui.add({s:'Galaxy'}, 's', ['Galaxy', 'Heart', 'Sphere']).onChange(v => updateShape(v));
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function updateShape(type) {
            const count = 6000; // 降低一点粒子数，提高手机加载速度
            const pos = new Float32Array(count * 3);
            for(let i=0; i<count; i++) {
                let x,y,z;
                if(type==='Galaxy') {
                    const a=i*0.1, r=2+i*0.005; x=Math.cos(a)*r; y=(Math.random()-0.5)*2; z=Math.sin(a)*r;
                } else if(type==='Heart') {
                    const t=(i/count)*Math.PI*2, p=Math.acos(-1+(2*i)/count), th=Math.sqrt(count*Math.PI)*p;
                    x=16*Math.pow(Math.sin(th),3)*0.5; y=(13*Math.cos(th)-5*Math.cos(2*th)-2*Math.cos(3*th)-Math.cos(4*th))*0.5; z=10*Math.cos(p)*0.5;
                } else {
                    const r=6, p=Math.acos(-1+(2*i)/count), th=Math.sqrt(count*Math.PI)*p;
                    x=r*Math.sin(p)*Math.cos(th); y=r*Math.sin(p)*Math.sin(th); z=r*Math.cos(p);
                }
                pos[i*3]=x+(Math.random()-0.5); pos[i*3+1]=y+(Math.random()-0.5); pos[i*3+2]=z+(Math.random()-0.5);
            }
            positionsOriginal = pos;
            if(!geometry) { geometry = new THREE.BufferGeometry(); geometry.setAttribute('position', new THREE.BufferAttribute(pos, 3)); }
        }

        function animate() {
            if(!isRunning) return;
            requestAnimationFrame(animate);
            const pos = particles.geometry.attributes.position.array;
            for(let i=0; i<positionsOriginal.length; i++) {
                pos[i] += (positionsOriginal[i]*handScaleFactor - pos[i]) * 0.1;
            }
            particles.geometry.attributes.position.needsUpdate = true;
            particles.rotation.y += 0.002;
            renderer.render(scene, camera);
        }

        function onHandResults(res) {
            if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                const lm = res.multiHandLandmarks[0];
                const d = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                const target = 0.5 + Math.min(Math.max((d-0.02)/0.18,0),1)*2.0;
                handScaleFactor += (target - handScaleFactor) * 0.1;
            } else {
                handScaleFactor += (1.0 - handScaleFactor) * 0.05;
            }
        }
    </script>
</body>
</html>
