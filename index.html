<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Hand Particles (VPN Required)</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: monospace; }
        
        /* å¼ºåˆ¶è°ƒè¯•æ¡†ï¼šé¡µé¢ä¸€æ‰“å¼€å¿…é¡»çœ‹åˆ°å®ƒï¼Œå¦åˆ™è¯´æ˜ HTML æ²¡åŠ è½½ */
        #debug-console {
            position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            background: rgba(20, 0, 0, 0.8); pointer-events: none;
            z-index: 999; padding: 10px; box-sizing: border-box;
            overflow-y: scroll; border-bottom: 2px solid red;
            font-size: 12px;
        }

        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #video-input { position: absolute; bottom: 10px; right: 10px; width: 100px; transform: scaleX(-1); z-index: 5; display: none; }
        
        /* å¯åŠ¨æŒ‰é’® */
        #start-btn {
            position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%);
            padding: 15px 40px; font-size: 18px; border-radius: 30px;
            background: #00d2ff; color: #000; border: none; cursor: pointer;
            z-index: 100; display: none; /* JS åŠ è½½æˆåŠŸåæ˜¾ç¤º */
            box-shadow: 0 0 20px #00d2ff;
        }
    </style>

    <script>
        function log(msg) {
            const box = document.getElementById('debug-console');
            if(box) {
                const line = document.createElement('div');
                line.textContent = `> ${msg}`;
                box.appendChild(line);
            }
            console.log(msg);
        }
        window.onerror = function(msg, source, line) {
            log(`âŒ ERROR: ${msg} (Line ${line})`);
            return false;
        };
        window.addEventListener('load', () => log("âœ… é¡µé¢æ¡†æ¶åŠ è½½å®Œæˆ"));
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "lil-gui": "https://cdn.jsdelivr.net/npm/lil-gui@0.19.1/dist/lil-gui.esm.min.js"
            }
        }
    </script>
</head>
<body>
    <div id="debug-console">
        <div>ğŸš€ åˆå§‹åŒ–æ—¥å¿— (å¦‚æœè¿™é‡Œå¡ä½ï¼Œè¯·æ£€æŸ¥ VPN)...</div>
    </div>
    
    <button id="start-btn">START CAMERA</button>
    <video id="video-input" playsinline></video>
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import GUI from 'lil-gui';

        log("ğŸ“¦ Three.js æ¨¡å—å¯¼å…¥æˆåŠŸ");

        // å…¨å±€å˜é‡
        let scene, camera, renderer, particles, geometry, material;
        let positionsOriginal = [], handScaleFactor = 1.0;
        let isRunning = false;
        const startBtn = document.getElementById('start-btn');
        const debugBox = document.getElementById('debug-console');

        // --- 1. èµ„æºè‡ªæ£€ ---
        const checkTimer = setInterval(() => {
            if (window.Hands && window.Camera) {
                clearInterval(checkTimer);
                log("âœ… MediaPipe åº“åŠ è½½æˆåŠŸ");
                startBtn.style.display = 'block';
                log("ğŸ‘‰ è¯·ç‚¹å‡»å±å¹•ä¸‹æ–¹çš„è“è‰²æŒ‰é’®å¯åŠ¨");
            } else {
                log("â³ ç­‰å¾… MediaPipe ä¸‹è½½...");
            }
        }, 1000);

        // --- 2. å¯åŠ¨é€»è¾‘ ---
        startBtn.addEventListener('click', async () => {
            log("ğŸš€ æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...");
            startBtn.style.display = 'none';
            debugBox.style.height = '100px'; // ç¼©å°è°ƒè¯•æ¡†

            try {
                // åˆå§‹åŒ– Hands
                const hands = new window.Hands({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }});
                
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                hands.onResults(onHandResults);

                // åˆå§‹åŒ–æ‘„åƒå¤´
                const video = document.getElementById('video-input');
                const cameraUtils = new window.Camera(video, {
                    onFrame: async () => { await hands.send({image: video}); },
                    width: 640, height: 480, facingMode: "user"
                });
                
                await cameraUtils.start();
                log("âœ… æ‘„åƒå¤´å·²å¯åŠ¨");
                video.style.display = 'block';

                // åˆå§‹åŒ– 3D
                initThree();
                animate();
                
                // æˆåŠŸåéšè—è°ƒè¯•æ¡†
                debugBox.style.display = 'none';
                isRunning = true;

            } catch (error) {
                log("âŒ å¯åŠ¨å¤±è´¥: " + error.message);
                alert("Error: " + error.message);
                startBtn.style.display = 'block';
            }
        });

        // --- 3. 3D é€»è¾‘ ---
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 20;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // ç²’å­ç”Ÿæˆ
            const count = 5000;
            geometry = new THREE.BufferGeometry();
            const pos = new Float32Array(count * 3);
            for(let i=0; i<count*3; i++) pos[i] = (Math.random()-0.5)*10;
            positionsOriginal = new Float32Array(pos); // åˆå§‹æš‚å­˜
            
            // é»˜è®¤å½¢çŠ¶: Galaxy
            updateShape('Galaxy');

            // ç®€å•çº¹ç†
            const cvs = document.createElement('canvas'); cvs.width=32; cvs.height=32;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(16,16,16,0,Math.PI*2); ctx.fill();
            const tex = new THREE.Texture(cvs); tex.needsUpdate = true;

            material = new THREE.PointsMaterial({ size: 0.15, map: tex, color: 0x00d2ff, transparent: true, opacity: 0.8 });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            // ç®€å•çš„ GUI
            const gui = new GUI();
            gui.add({s:'Galaxy'}, 's', ['Galaxy', 'Sphere']).onChange(v => updateShape(v));
        }

        function updateShape(type) {
            const count = 5000;
            const arr = new Float32Array(count*3);
            for(let i=0; i<count; i++) {
                let x,y,z;
                if(type === 'Galaxy') {
                    const a=i*0.1, r=2+i*0.005;
                    x=Math.cos(a)*r; y=(Math.random()-0.5)*2; z=Math.sin(a)*r;
                } else {
                    const r=6, theta=Math.random()*Math.PI*2, phi=Math.acos(2*Math.random()-1);
                    x=r*Math.sin(phi)*Math.cos(theta); y=r*Math.sin(phi)*Math.sin(theta); z=r*Math.cos(phi);
                }
                arr[i*3]=x; arr[i*3+1]=y; arr[i*3+2]=z;
            }
            positionsOriginal = arr;
            if(!geometry) geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(new Float32Array(arr), 3));
        }

        function animate() {
            if(!isRunning) return;
            requestAnimationFrame(animate);
            
            const pos = particles.geometry.attributes.position.array;
            for(let i=0; i<pos.length; i++) {
                pos[i] += (positionsOriginal[i]*handScaleFactor - pos[i]) * 0.1;
            }
            particles.geometry.attributes.position.needsUpdate = true;
            particles.rotation.y += 0.002;
            renderer.render(scene, camera);
        }

        function onHandResults(res) {
            if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                const lm = res.multiHandLandmarks[0];
                const d = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                const target = 0.5 + Math.min(Math.max((d-0.02)/0.18,0),1)*2.0;
                handScaleFactor += (target - handScaleFactor) * 0.1;
            } else {
                handScaleFactor += (1.0 - handScaleFactor) * 0.05;
            }
        }
    </script>
</body>
</html>
